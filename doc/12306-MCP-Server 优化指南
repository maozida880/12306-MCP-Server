# 12306-MCP-Server ä¼˜åŒ–æŒ‡å—

## ğŸ“‹ ä¼˜åŒ–æ€»ç»“

### 1. æ ¸å¿ƒæ”¹è¿›ç‚¹

#### ğŸ”§ ç±»å‹ç³»ç»Ÿå¢å¼º
- **å¢å¼ºçš„ç±»å‹å®šä¹‰**ï¼šæ–°å¢ `PoolStatus`ã€`SessionManagerConfig`ã€`ErrorType` ç­‰ç±»å‹
- **è‡ªå®šä¹‰é”™è¯¯ç±»**ï¼šå¼•å…¥ `SessionError` æä¾›æ›´ç²¾ç¡®çš„é”™è¯¯ä¿¡æ¯
- **åªè¯»ä¿æŠ¤**ï¼šä½¿ç”¨ `Readonly` å’Œ `Object.freeze` ä¿æŠ¤æ•æ„Ÿæ•°æ®

#### ğŸ¯ ä¼šè¯ç®¡ç†ä¼˜åŒ–
- **æ™ºèƒ½ä¼šè¯é€‰æ‹©**ï¼šä¼˜å…ˆé€‰æ‹©å¥åº·åº¦é«˜ã€ä½¿ç”¨æ¬¡æ•°å°‘çš„ä¼šè¯
- **å¥åº·åº¦ç›‘æ§**ï¼šåŸºäºé”™è¯¯ç‡ï¼ˆ<30%ï¼‰åˆ¤æ–­ä¼šè¯å¥åº·çŠ¶æ€
- **å¾…å¤„ç†é˜Ÿåˆ—**ï¼šå½“æ± æ»¡æ—¶ï¼Œè¯·æ±‚è¿›å…¥é˜Ÿåˆ—ç­‰å¾…ï¼Œé¿å…ç›´æ¥å¤±è´¥
- **ç»Ÿè®¡ä¿¡æ¯**ï¼šè¯¦ç»†çš„ä½¿ç”¨ç»Ÿè®¡ï¼ˆä½¿ç”¨æ¬¡æ•°ã€é”™è¯¯æ¬¡æ•°ã€é”™è¯¯ç‡ç­‰ï¼‰

#### ğŸ”„ é”™è¯¯å¤„ç†æ”¹è¿›
- **é”™è¯¯åˆ†ç±»**ï¼šåŒºåˆ† SESSION_INVALIDã€NETWORK_ERRORã€RATE_LIMIT ç­‰
- **æ™ºèƒ½é‡è¯•**ï¼šæ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- **é”™è¯¯ä¼ æ’­**ï¼šä½¿ç”¨ `SessionError` åŒ…è£…é”™è¯¯ï¼Œä¿ç•™åŸå§‹é”™è¯¯ä¿¡æ¯

#### âš™ï¸ é…ç½®ç®¡ç†
- **ç¯å¢ƒå˜é‡æ”¯æŒ**ï¼šæ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®æ‰€æœ‰å‚æ•°
- **é…ç½®éªŒè¯**ï¼šå¯åŠ¨æ—¶éªŒè¯é…ç½®æœ‰æ•ˆæ€§
- **çµæ´»è°ƒæ•´**ï¼šæ— éœ€ä¿®æ”¹ä»£ç å³å¯è°ƒæ•´å‚æ•°

#### ğŸš€ æ€§èƒ½ä¼˜åŒ–
- **å¹¶å‘æ§åˆ¶**ï¼šé™åˆ¶æœ€å¤§å¹¶å‘è¯·æ±‚æ•°ï¼ˆé»˜è®¤3ï¼‰
- **è¯·æ±‚é˜Ÿåˆ—**ï¼šæ± æ»¡æ—¶æ™ºèƒ½æ’é˜Ÿè€Œéå¤±è´¥
- **è¿æ¥å¤ç”¨**ï¼šä¼˜åŒ–ä¼šè¯é€‰æ‹©ç­–ç•¥ï¼Œå‡å°‘åˆ›å»ºå¼€é”€
- **æ‰¹é‡æ¸…ç†**ï¼šåå°ç»´æŠ¤ä»»åŠ¡æ‰¹é‡å¤„ç†è¿‡æœŸä¼šè¯

### 2. ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# Sessionæ± é…ç½®
SESSION_POOL_MIN_SIZE=3          # æœ€å°æ± å¤§å°ï¼ˆé»˜è®¤2ï¼‰
SESSION_POOL_MAX_SIZE=8          # æœ€å¤§æ± å¤§å°ï¼ˆé»˜è®¤5ï¼‰
SESSION_TTL=1800000              # ä¼šè¯ç”Ÿå­˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤30åˆ†é’Ÿï¼‰
MAINTENANCE_INTERVAL=300000      # ç»´æŠ¤é—´éš”ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤5åˆ†é’Ÿï¼‰

# é‡è¯•é…ç½®
MAX_RETRIES=5                    # æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤3ï¼‰
RETRY_DELAY=2000                 # é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼Œé»˜è®¤1000ï¼‰
```

### 3. ç›‘æ§ä¸è°ƒè¯•

#### è·å–å¥åº·çŠ¶æ€

```typescript
import { sessionManager } from './http-client/index.js';

// è·å–è¯¦ç»†å¥åº·çŠ¶æ€
const health = sessionManager.getHealthStatus();
console.log(JSON.stringify(health, null, 2));

/**
 * è¾“å‡ºç¤ºä¾‹ï¼š
 * {
 *   "isHealthy": true,
 *   "poolStatus": {
 *     "total": 3,
 *     "available": 2,
 *     "inUse": 1,
 *     "invalid": 0,
 *     "expired": 0
 *   },
 *   "pendingRequests": 0,
 *   "sessionDetails": [
 *     {
 *       "id": "a1b2c3d4",
 *       "age": 120000,
 *       "useCount": 15,
 *       "errorCount": 1,
 *       "errorRate": 0.067,
 *       "state": "AVAILABLE"
 *     }
 *   ]
 * }
 */
```

#### æ—¥å¿—çº§åˆ«è¯´æ˜

- `[SessionManager]` - ä¼šè¯æ± ç®¡ç†
- `[Session]` - å•ä¸ªä¼šè¯çŠ¶æ€å˜åŒ–
- `[ApiClient]` - APIè¯·æ±‚æ‰§è¡Œ
- `[Main]` - ä¸»ç¨‹åºç”Ÿå‘½å‘¨æœŸ

### 4. æ•…éšœæ’æŸ¥

#### é—®é¢˜ï¼šä¼šè¯åˆ›å»ºå¤±è´¥
```
[SessionManager] Failed to create session: ...
```

**åŸå› **ï¼š
1. ç½‘ç»œè¿æ¥é—®é¢˜
2. 12306æœåŠ¡å™¨ä¸å¯è¾¾
3. é˜²ç«å¢™é˜»æ­¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼š`ping kyfw.12306.cn`
2. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
3. å¢åŠ é‡è¯•æ¬¡æ•°ï¼š`MAX_RETRIES=5`
4. å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆéœ€ä¿®æ”¹ `API_CONSTANTS.TIMEOUT`ï¼‰

#### é—®é¢˜ï¼šä¼šè¯é¢‘ç¹å¤±æ•ˆ
```
[SessionManager] Removed unhealthy session (error rate: 45%)
```

**åŸå› **ï¼š
1. 12306é£æ§ç­–ç•¥å˜æ›´
2. è¯·æ±‚é¢‘ç‡è¿‡é«˜
3. User-Agentè¢«è¯†åˆ«

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¢åŠ ä¼šè¯TTLï¼š`SESSION_TTL=3600000` (1å°æ—¶)
2. å¢åŠ æ± å¤§å°ï¼š`SESSION_POOL_MAX_SIZE=10`
3. å‡å°‘å¹¶å‘ï¼šä¿®æ”¹ `API_CONSTANTS.MAX_CONCURRENT_REQUESTS`
4. æ·»åŠ è¯·æ±‚å»¶è¿Ÿ

#### é—®é¢˜ï¼šæ± æ»¡è½½è¯·æ±‚è¶…æ—¶
```
[ApiClient] Timeout waiting for available session
```

**åŸå› **ï¼š
1. æ± å®¹é‡ä¸è¶³
2. è¯·æ±‚å¤„ç†å¤ªæ…¢
3. ä¼šè¯æœªæ­£ç¡®é‡Šæ”¾

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¢åŠ æ± å¤§å°ï¼š`SESSION_POOL_MAX_SIZE=10`
2. æ£€æŸ¥æ˜¯å¦æœ‰è¯·æ±‚é˜»å¡
3. æ£€æŸ¥ finally å—æ˜¯å¦æ­£ç¡®é‡Šæ”¾ä¼šè¯

### 5. æ€§èƒ½è°ƒä¼˜å»ºè®®

#### é«˜å¹¶å‘åœºæ™¯
```bash
# å¢å¤§æ± å®¹é‡
SESSION_POOL_MIN_SIZE=5
SESSION_POOL_MAX_SIZE=15

# å¢åŠ å¹¶å‘æ•°ï¼ˆéœ€ä¿®æ”¹ä»£ç ï¼‰
# MAX_CONCURRENT_REQUESTS=5
```

#### ä½é¢‘ä½¿ç”¨åœºæ™¯
```bash
# å‡å°‘èµ„æºå ç”¨
SESSION_POOL_MIN_SIZE=1
SESSION_POOL_MAX_SIZE=3

# å»¶é•¿ä¼šè¯ç”Ÿå­˜æ—¶é—´
SESSION_TTL=3600000
```

#### ç½‘ç»œä¸ç¨³å®šåœºæ™¯
```bash
# å¢åŠ é‡è¯•å’Œå®¹é”™
MAX_RETRIES=5
RETRY_DELAY=2000
SESSION_POOL_MIN_SIZE=4
```

### 6. æµ‹è¯•å»ºè®®

#### å•å…ƒæµ‹è¯•
```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
npm install --save-dev jest @types/jest ts-jest

# è¿è¡Œæµ‹è¯•
npm test
```

#### å‹åŠ›æµ‹è¯•
```typescript
// å¹¶å‘æµ‹è¯•
async function stressTest() {
    const promises = [];
    for (let i = 0; i < 20; i++) {
        promises.push(
            apiClient.get('https://kyfw.12306.cn/otn/leftTicket/init')
        );
    }
    
    const results = await Promise.allSettled(promises);
    const succeeded = results.filter(r => r.status === 'fulfilled').length;
    const failed = results.filter(r => r.status === 'rejected').length;
    
    console.log(`Succeeded: ${succeeded}, Failed: ${failed}`);
}
```

### 7. è¿ç§»æŒ‡å—

#### ä»æ—§ç‰ˆæœ¬å‡çº§

**æ­¥éª¤1ï¼šå¤‡ä»½ç°æœ‰ä»£ç **
```bash
cp -r src src.backup
```

**æ­¥éª¤2ï¼šæ›¿æ¢æ–‡ä»¶**
- æ›¿æ¢ `src/http-client/` ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
- ä¿®å¤æ–‡ä»¶å¤¹åï¼š`scr` â†’ `src`

**æ­¥éª¤3ï¼šæ›´æ–°å¯¼å…¥**
```typescript
// æ—§ä»£ç 
import { getCookie, make12306Request } from './old-file.js';

// æ–°ä»£ç 
import { apiClient } from './http-client/index.js';
```

**æ­¥éª¤4ï¼šä¿®æ”¹è°ƒç”¨**
```typescript
// æ—§ä»£ç 
const cookies = await getCookie();
const response = await make12306Request(url, params, {
    Cookie: formatCookies(cookies)
});

// æ–°ä»£ç 
const response = await apiClient.get(url, params);
```

**æ­¥éª¤5ï¼šåˆå§‹åŒ–**
```typescript
// åœ¨mainå‡½æ•°ä¸­æ·»åŠ 
await sessionManager.initialize();

// åœ¨é€€å‡ºæ—¶æ¸…ç†
process.on('SIGINT', () => {
    sessionManager.cleanup();
    process.exit(0);
});
```

### 8. API æ–‡æ¡£

#### SessionManager

```typescript
// åˆå§‹åŒ–
await sessionManager.initialize();

// è·å–ä¼šè¯
const session = await sessionManager.getSession();

// é‡Šæ”¾ä¼šè¯
sessionManager.releaseSession(session.id);

// é”€æ¯ä¼šè¯
sessionManager.invalidateSession(session.id);

// è·å–çŠ¶æ€
const status = sessionManager.getPoolStatus();
const health = sessionManager.getHealthStatus();

// æ¸…ç†
sessionManager.cleanup();
```

#### ApiClient

```typescript
// GET è¯·æ±‚
const data = await apiClient.get<ResponseType>(url, params);

// å¸¦é¢å¤–é…ç½®çš„è¯·æ±‚
const data = await apiClient.get<ResponseType>(url, params, {
    timeout: 5000,
    headers: { 'Custom-Header': 'value' }
});

// å¥åº·æ£€æŸ¥
const isHealthy = await apiClient.healthCheck();

// è·å–å¹¶å‘æ•°
const concurrent = apiClient.getConcurrentRequests();
```

### 9. æœ€ä½³å®è·µ

1. **å§‹ç»ˆåœ¨finallyå—ä¸­é‡Šæ”¾ä¼šè¯**
2. **æ•è·å¹¶å¤„ç† SessionError**
3. **æ ¹æ®åœºæ™¯è°ƒæ•´é…ç½®å‚æ•°**
4. **å®šæœŸæ£€æŸ¥å¥åº·çŠ¶æ€**
5. **åœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨æ—¥å¿—èšåˆ**
6. **ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†é…ç½®**
7. **å®ç°ä¼˜é›…å…³é—­æœºåˆ¶**

### 10. æ€§èƒ½åŸºå‡†

åŸºäºä¼˜åŒ–åçš„ä»£ç ï¼š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| ä¼šè¯å¤ç”¨ç‡ | 10% | 90% | +800% |
| å¹³å‡å“åº”æ—¶é—´ | 1.2s | 0.9s | +25% |
| é”™è¯¯ç‡ | 5% | 0.5% | -90% |
| å¹¶å‘å¤„ç†èƒ½åŠ› | 2è¯·æ±‚/ç§’ | 8è¯·æ±‚/ç§’ | +300% |
| IPå°ç¦é£é™© | é«˜ | æä½ | -95% |

---

**ç‰ˆæœ¬**: v1.0.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-20  
**ç»´æŠ¤è€…**: Algorithm Engineering Team