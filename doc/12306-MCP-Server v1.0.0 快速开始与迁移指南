# 12306-MCP-Server v1.0.0 å¿«é€Ÿå¼€å§‹ä¸è¿ç§»æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆå…¨æ–°å®‰è£…ï¼‰

### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/your-username/12306-mcp-server.git
cd 12306-mcp-server
```

### 2. å®‰è£…ä¾èµ–
```bash
npm install
```

### 3. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰
```bash
# åˆ›å»º .env æ–‡ä»¶
cat > .env << EOF
# Sessionæ± é…ç½®
SESSION_POOL_MIN_SIZE=3
SESSION_POOL_MAX_SIZE=8
SESSION_TTL=1800000
MAINTENANCE_INTERVAL=300000

# é‡è¯•é…ç½®
MAX_RETRIES=3
RETRY_DELAY=1000

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=info
EOF
```

### 4. æ„å»ºé¡¹ç›®
```bash
npm run build
```

### 5. è¿è¡ŒæœåŠ¡
```bash
# stdio æ¨¡å¼ï¼ˆæ¨èç”¨äºæœ¬åœ°å¼€å‘ï¼‰
npm start

# æˆ– HTTP æ¨¡å¼
npm run start:http -- --port 8080
```

### 6. æµ‹è¯•æœåŠ¡
```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯
curl http://localhost:8080/health
```

## ğŸ“¦ ä» v0.3.x è¿ç§»åˆ° v1.0.0

### æ­¥éª¤1: å¤‡ä»½å½“å‰ä»£ç 
```bash
# å¤‡ä»½æ•´ä¸ªé¡¹ç›®
cp -r . ../12306-mcp-server-backup

# æˆ–ä»…å¤‡ä»½ src ç›®å½•
cp -r scr scr.backup
```

### æ­¥éª¤2: ä¿®å¤æ–‡ä»¶è·¯å¾„
```bash
# é‡å‘½åæ–‡ä»¶å¤¹
mv scr src

# æ›´æ–° package.json ä¸­çš„å¼•ç”¨
sed -i 's/scr\//src\//g' package.json
sed -i 's/"scr"/"src"/g' package.json

# æ›´æ–° tsconfig.json
sed -i 's/"scr"/"src"/g' tsconfig.json
```

### æ­¥éª¤3: æ›¿æ¢ä¼˜åŒ–åçš„æ–‡ä»¶

å°†ä»¥ä¸‹æ–‡ä»¶æ›¿æ¢ä¸ºä¼˜åŒ–åçš„ç‰ˆæœ¬ï¼š

```bash
# æ ¸å¿ƒæ–‡ä»¶
src/http-client/types.ts         # âœ… å¢å¼ºçš„ç±»å‹å®šä¹‰
src/http-client/constants.ts     # âœ… æ”¯æŒç¯å¢ƒå˜é‡
src/http-client/session.ts       # âœ… å¢åŠ ç»Ÿè®¡å’Œå¥åº·æ£€æŸ¥
src/http-client/sessionManager.ts  # âœ… æ™ºèƒ½ä¼šè¯ç®¡ç†
src/http-client/apiClient.ts     # âœ… é”™è¯¯åˆ†ç±»å’Œé‡è¯•
```

### æ­¥éª¤4: æ›´æ–°ä¸»å…¥å£æ–‡ä»¶

åœ¨ `src/index.ts` ä¸­ï¼Œç¡®ä¿åˆå§‹åŒ–é€»è¾‘æ­£ç¡®ï¼š

```typescript
// åœ¨æ–‡ä»¶é¡¶éƒ¨ï¼Œç§»é™¤é¡¶å±‚await
// âŒ æ—§ä»£ç 
const LCQUERY_PATH = await getLCQueryPath();
const STATIONS: Record<string, StationData> = await getStations();

// âœ… æ–°ä»£ç 
let LCQUERY_PATH: string;
let STATIONS: Record<string, StationData>;

// åœ¨ init() å‡½æ•°ä¸­åˆå§‹åŒ–
async function init() {
    console.log('[Main] Initializing 12306-MCP service...');
    
    // å…ˆåˆå§‹åŒ–åŸºç¡€æ•°æ®
    LCQUERY_PATH = await getLCQueryPath();
    STATIONS = await getStations();
    
    // å†åˆå§‹åŒ–ä¼šè¯ç®¡ç†å™¨
    await sessionManager.initialize();
    
    console.log('[Main] Service initialized successfully');
}
```

### æ­¥éª¤5: æ›´æ–° API è°ƒç”¨

æŸ¥æ‰¾æ‰€æœ‰ `make12306Request` çš„è°ƒç”¨ï¼Œæ›¿æ¢ä¸º `apiClient.get`ï¼š

**ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ‰¹é‡æ›¿æ¢ï¼š**

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
find src -name "*.ts" -type f -exec sed -i \
  's/make12306Request(\([^,]*\),\s*\([^,]*\),\s*{.*Cookie:.*})/apiClient.get(\1, \2)/g' {} +
```

**æˆ–æ‰‹åŠ¨æ›¿æ¢æ¯ä¸ªè°ƒç”¨ï¼š**

```typescript
// âŒ æ—§ä»£ç 
const cookies = await getCookie();
const response = await make12306Request(queryUrl, queryParams, {
    Cookie: formatCookies(cookies)
});

// âœ… æ–°ä»£ç 
const response = await apiClient.get<ResponseType>(queryUrl, queryParams);
```

### æ­¥éª¤6: å®‰è£…æ–°ä¾èµ–ï¼ˆå¦‚éœ€è¦ï¼‰

```bash
# å¦‚æœæ·»åŠ äº†æ–°çš„ä¾èµ–
npm install

# æ›´æ–°ç±»å‹å®šä¹‰
npm install --save-dev @types/node
```

### æ­¥éª¤7: é‡æ–°æ„å»º
```bash
# æ¸…ç†æ—§æ„å»º
rm -rf build/

# é‡æ–°æ„å»º
npm run build
```

### æ­¥éª¤8: æµ‹è¯•
```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
npm test

# å¯åŠ¨æœåŠ¡å¹¶æµ‹è¯•
npm start
```

## ğŸ” è¿ç§»æ£€æŸ¥æ¸…å•

### æ–‡ä»¶ç»“æ„
- [ ] `scr/` é‡å‘½åä¸º `src/`
- [ ] `src/http-client/types.ts` åŒ…å«æ­£ç¡®çš„ç±»å‹å®šä¹‰
- [ ] `src/http-client/constants.ts` æ”¯æŒç¯å¢ƒå˜é‡
- [ ] `src/http-client/session.ts` åŒ…å«ç»Ÿè®¡åŠŸèƒ½
- [ ] `src/http-client/sessionManager.ts` åŒ…å«é˜Ÿåˆ—ç®¡ç†
- [ ] `src/http-client/apiClient.ts` åŒ…å«é”™è¯¯åˆ†ç±»

### ä»£ç æ›´æ–°
- [ ] ç§»é™¤ `getCookie()` å‡½æ•°
- [ ] ç§»é™¤ `make12306Request()` å‡½æ•°
- [ ] æ‰€æœ‰è¯·æ±‚æ”¹ç”¨ `apiClient.get()`
- [ ] é¡¶å±‚ await ç§»åˆ° `init()` å‡½æ•°
- [ ] æ·»åŠ  `cleanup()` è°ƒç”¨

### é…ç½®
- [ ] åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
- [ ] éªŒè¯ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ
- [ ] è°ƒæ•´æ± å¤§å°å‚æ•°
- [ ] é…ç½®æ—¥å¿—çº§åˆ«

### æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸
- [ ] ä¼šè¯æ± æ­£å¸¸å·¥ä½œ
- [ ] é”™è¯¯å¤„ç†æ­£ç¡®

## ğŸ› è¿ç§»å¸¸è§é—®é¢˜

### Q1: æ„å»ºå¤±è´¥ï¼Œæç¤ºæ‰¾ä¸åˆ°æ¨¡å—
```
Error: Cannot find module './http-client/index.js'
```

**è§£å†³**:
```bash
# ç¡®ä¿æ–‡ä»¶å¤¹åç§°æ­£ç¡®
ls -la src/http-client/

# é‡æ–°æ„å»º
npm run build

# æ£€æŸ¥ tsconfig.json
cat tsconfig.json | grep "src"
```

### Q2: è¿è¡Œæ—¶æŠ¥é”™ "SessionManager is not initialized"
```
Error: SessionManager is not initialized
```

**è§£å†³**:
```typescript
// ç¡®ä¿åœ¨ä½¿ç”¨å‰åˆå§‹åŒ–
async function main() {
    await sessionManager.initialize();  // âœ… å¿…é¡»ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
    
    // ç„¶åå†å¯åŠ¨æœåŠ¡
    await server.connect(transport);
}
```

### Q3: ä¼šè¯æ± åˆ›å»ºå¤±è´¥
```
[SessionManager] Failed to create any sessions during initialization
```

**è§£å†³**:
```bash
# 1. æ£€æŸ¥ç½‘ç»œè¿æ¥
ping kyfw.12306.cn

# 2. æ£€æŸ¥é˜²ç«å¢™
sudo ufw status

# 3. å°è¯•æ‰‹åŠ¨è®¿é—®
curl -I https://kyfw.12306.cn/otn/leftTicket/init

# 4. å¢åŠ é‡è¯•æ¬¡æ•°
export MAX_RETRIES=5
export RETRY_DELAY=2000
```

### Q4: TypeScript ç¼–è¯‘é”™è¯¯
```
error TS2307: Cannot find module './types.js'
```

**è§£å†³**:
```typescript
// ç¡®ä¿ä½¿ç”¨ .js æ‰©å±•åï¼ˆå³ä½¿æ˜¯ TypeScriptï¼‰
import { SessionState } from './types.js';  // âœ… æ­£ç¡®
import { SessionState } from './types';     // âŒ é”™è¯¯
```

### Q5: ç¯å¢ƒå˜é‡ä¸ç”Ÿæ•ˆ
```bash
# å®‰è£… dotenv
npm install dotenv

# åœ¨å…¥å£æ–‡ä»¶é¡¶éƒ¨æ·»åŠ 
import 'dotenv/config';

# æˆ–åœ¨å¯åŠ¨è„šæœ¬ä¸­
node -r dotenv/config build/index.js
```

## ğŸ“Š è¿ç§»å‰åå¯¹æ¯”

### API è°ƒç”¨å¯¹æ¯”

**æ—§ç‰ˆæœ¬**:
```typescript
// æ­¥éª¤ç¹çï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†Cookie
const cookies = await getCookie();
const headers = {
    Cookie: Object.entries(cookies)
        .map(([k, v]) => `${k}=${v}`)
        .join('; '),
    'User-Agent': 'Mozilla/5.0...'
};
const response = await make12306Request(url, params, headers);
```

**æ–°ç‰ˆæœ¬**:
```typescript
// ä¸€è¡Œä»£ç ï¼Œè‡ªåŠ¨ç®¡ç†
const response = await apiClient.get<ResponseType>(url, params);
```

### é”™è¯¯å¤„ç†å¯¹æ¯”

**æ—§ç‰ˆæœ¬**:
```typescript
try {
    const response = await make12306Request(url, params, headers);
} catch (error) {
    // æ— æ³•åŒºåˆ†é”™è¯¯ç±»å‹
    console.error('Request failed:', error);
}
```

**æ–°ç‰ˆæœ¬**:
```typescript
try {
    const response = await apiClient.get<ResponseType>(url, params);
} catch (error) {
    if (error instanceof SessionError) {
        switch (error.type) {
            case ErrorType.SESSION_INVALID:
                console.log('ä¼šè¯å¤±æ•ˆï¼Œå·²è‡ªåŠ¨é‡è¯•');
                break;
            case ErrorType.NETWORK_ERROR:
                console.log('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
                break;
            case ErrorType.RATE_LIMIT:
                console.log('è¯·æ±‚è¿‡å¿«ï¼Œè¯·ç¨åé‡è¯•');
                break;
        }
    }
}
```

## ğŸ‰ è¿ç§»å®ŒæˆéªŒè¯

### 1. åŠŸèƒ½éªŒè¯
```bash
# æµ‹è¯•è½¦ç¥¨æŸ¥è¯¢
curl -X POST http://localhost:8080/tools/get-tickets \
  -H "Content-Type: application/json" \
  -d '{
    "date": "2025-11-01",
    "fromStation": "BJP",
    "toStation": "SHH"
  }'
```

### 2. æ€§èƒ½éªŒè¯
```bash
# ä½¿ç”¨ ab è¿›è¡Œå‹åŠ›æµ‹è¯•
ab -n 100 -c 10 http://localhost:8080/health
```

### 3. ç›‘æ§éªŒè¯
```typescript
// æ£€æŸ¥ä¼šè¯æ± çŠ¶æ€
const health = sessionManager.getHealthStatus();
console.log('Pool Status:', health.poolStatus);
console.log('Pending Requests:', health.pendingRequests);
```

### 4. æ—¥å¿—éªŒè¯
```bash
# æŸ¥çœ‹æ—¥å¿—è¾“å‡º
tail -f logs/app.log | grep SessionManager
```

## ğŸ“š ä¸‹ä¸€æ­¥

1. **é˜…è¯»ä¼˜åŒ–æŒ‡å—**: äº†è§£å¦‚ä½•è°ƒä¼˜é…ç½®
2. **æŸ¥çœ‹ä»£ç å®¡æŸ¥æŠ¥å‘Š**: äº†è§£æ½œåœ¨æ”¹è¿›ç‚¹
3. **é…ç½®ç›‘æ§**: æ·»åŠ  Prometheus æŒ‡æ ‡
4. **ç¼–å†™æµ‹è¯•**: æé«˜æµ‹è¯•è¦†ç›–ç‡
5. **ä¼˜åŒ–éƒ¨ç½²**: ä½¿ç”¨ Docker å®¹å™¨åŒ–

## ğŸ†˜ è·å–å¸®åŠ©

- **GitHub Issues**: https://github.com/your-username/12306-mcp-server/issues
- **æ–‡æ¡£**: æŸ¥çœ‹é¡¹ç›® `doc/` ç›®å½•
- **ç¤¾åŒº**: [è®¨è®ºåŒºé“¾æ¥]

---

**è¿ç§»æŒ‡å—ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-10-20  
**é¢„è®¡è¿ç§»æ—¶é—´**: 30-60åˆ†é’Ÿ