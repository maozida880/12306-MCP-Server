# 12306-MCP-Server ä»£ç å®¡æŸ¥æŠ¥å‘Š

## ğŸ”´ ä¸¥é‡é—®é¢˜ (Critical)

### 1. æ–‡ä»¶è·¯å¾„é”™è¯¯
**ä½ç½®**: é¡¹ç›®æ ¹ç›®å½•  
**é—®é¢˜**: æ–‡ä»¶å¤¹å‘½åä¸º `scr/` è€Œéæ ‡å‡†çš„ `src/`  
**å½±å“**: å¯èƒ½å¯¼è‡´æ„å»ºå¤±è´¥ã€IDEæ”¯æŒå¼‚å¸¸  
**ä¿®å¤**: 
```bash
mv scr src
# æ›´æ–° package.json ä¸­çš„è·¯å¾„å¼•ç”¨
```

### 2. types.js å†…å®¹é”™è¯¯
**ä½ç½®**: `scr/types.js`  
**é—®é¢˜**: è¯¥æ–‡ä»¶å†…å®¹ä¸ `index.js` å®Œå…¨ç›¸åŒï¼Œåº”è¯¥åªåŒ…å«ç±»å‹å®šä¹‰  
**å½±å“**: å¯¼è‡´ç±»å‹å®šä¹‰ä¸¢å¤±ï¼Œè¿è¡Œæ—¶å¯èƒ½å‡ºé”™  
**ä¿®å¤**: ä½¿ç”¨ä¼˜åŒ–åçš„ types.ts æ›¿æ¢

### 3. ç¼ºå°‘é”™è¯¯è¾¹ç•Œ
**ä½ç½®**: `index.js` ä¸­çš„ `getStations()` å’Œ `getLCQueryPath()`  
**é—®é¢˜**: è¿™äº›å‡½æ•°åœ¨æ¨¡å—é¡¶å±‚è°ƒç”¨ï¼Œå¦‚æœå¤±è´¥ä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡æ— æ³•å¯åŠ¨  
**ä¿®å¤**:
```typescript
// åœ¨ init() å‡½æ•°ä¸­è°ƒç”¨ï¼Œè€Œéé¡¶å±‚
let STATIONS: Record<string, StationData>;
let LCQUERY_PATH: string;

async function init() {
    console.log('[Main] Initializing...');
    STATIONS = await getStations();
    LCQUERY_PATH = await getLCQueryPath();
    await sessionManager.initialize();
}
```

## ğŸŸ¡ é‡è¦é—®é¢˜ (Major)

### 4. å†…å­˜æ³„æ¼é£é™©
**ä½ç½®**: `sessionManager.ts` çš„ `waitForAvailableSession()`  
**é—®é¢˜**: å¦‚æœè¯·æ±‚åœ¨è¶…æ—¶å‰æœåŠ¡å…³é—­ï¼Œtimeout ä¸ä¼šè¢«æ¸…ç†  
**ä¿®å¤**: å·²åœ¨ä¼˜åŒ–ç‰ˆæœ¬ä¸­æ·»åŠ æ¸…ç†é€»è¾‘

### 5. å¹¶å‘æ§åˆ¶ç¼ºå¤±
**ä½ç½®**: `apiClient.ts`  
**é—®é¢˜**: åŸç‰ˆæ²¡æœ‰é™åˆ¶å¹¶å‘è¯·æ±‚æ•°ï¼Œå¯èƒ½å¯¼è‡´èµ„æºè€—å°½  
**ä¿®å¤**: å·²åœ¨ä¼˜åŒ–ç‰ˆæœ¬ä¸­æ·»åŠ å¹¶å‘æ§åˆ¶

### 6. é…ç½®ç¡¬ç¼–ç 
**ä½ç½®**: `constants.ts`  
**é—®é¢˜**: æ‰€æœ‰é…ç½®éƒ½æ˜¯ç¡¬ç¼–ç ï¼Œä¸ä¾¿äºéƒ¨ç½²æ—¶è°ƒæ•´  
**ä¿®å¤**: å·²æ”¯æŒç¯å¢ƒå˜é‡é…ç½®

### 7. é”™è¯¯å¤„ç†ä¸å¤Ÿç²¾ç»†
**ä½ç½®**: `apiClient.ts` çš„ `isSessionInvalidError()`  
**é—®é¢˜**: åªåˆ¤æ–­ä¼šè¯å¤±æ•ˆï¼Œæ— æ³•åŒºåˆ†å…¶ä»–é”™è¯¯ç±»å‹  
**ä¿®å¤**: å·²æ·»åŠ  `ErrorType` æšä¸¾å’Œ `classifyError()` æ–¹æ³•

## ğŸŸ¢ æ¬¡è¦é—®é¢˜ (Minor)

### 8. æ—¥å¿—è¿‡äºç®€å•
**é—®é¢˜**: ç¼ºå°‘ç»“æ„åŒ–æ—¥å¿—å’Œæ—¥å¿—çº§åˆ«  
**å»ºè®®**: å¼•å…¥ winston æˆ– pino æ—¥å¿—åº“
```typescript
import winston from 'winston';

const logger = winston.createLogger({
    level: process.env.LOG_LEVEL || 'info',
    format: winston.format.json(),
    transports: [
        new winston.transports.File({ filename: 'error.log', level: 'error' }),
        new winston.transports.Console({ format: winston.format.simple() })
    ]
});
```

### 9. ç¼ºå°‘è¯·æ±‚æŒ‡æ ‡æ”¶é›†
**å»ºè®®**: æ·»åŠ  Prometheus æŒ‡æ ‡
```typescript
import promClient from 'prom-client';

const requestDuration = new promClient.Histogram({
    name: 'http_request_duration_seconds',
    help: 'Duration of HTTP requests in seconds',
    labelNames: ['method', 'status']
});
```

### 10. Session é€‰æ‹©ç­–ç•¥å¯ä¼˜åŒ–
**é—®é¢˜**: å½“å‰åªæŒ‰ä½¿ç”¨æ¬¡æ•°é€‰æ‹©ï¼Œå¯ä»¥è€ƒè™‘æ›´å¤šå› ç´   
**å»ºè®®**:
```typescript
// ç»¼åˆè¯„åˆ†
private calculateSessionScore(session: Session): number {
    const ageWeight = 0.3;
    const useCountWeight = 0.4;
    const errorRateWeight = 0.3;
    
    const ageScore = 1 - (session.getAge() / this.config.sessionTTL);
    const useScore = 1 / (session.useCount + 1);
    const errorScore = 1 - (session.errorCount / (session.useCount || 1));
    
    return ageScore * ageWeight + useScore * useCountWeight + errorScore * errorRateWeight;
}
```

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### 1. å¢åŠ ç¼“å­˜å±‚
å¯¹äºè½¦ç«™ä¿¡æ¯ç­‰ä¸å¸¸å˜åŒ–çš„æ•°æ®ï¼Œå¯ä»¥æ·»åŠ ç¼“å­˜ï¼š
```typescript
import NodeCache from 'node-cache';

const cache = new NodeCache({ stdTTL: 3600 });

async function getStationsWithCache(): Promise<Record<string, StationData>> {
    const cached = cache.get<Record<string, StationData>>('stations');
    if (cached) return cached;
    
    const stations = await getStations();
    cache.set('stations', stations);
    return stations;
}
```

### 2. å®ç°æ–­è·¯å™¨æ¨¡å¼
é˜²æ­¢é›ªå´©æ•ˆåº”ï¼š
```typescript
class CircuitBreaker {
    private failures = 0;
    private state: 'CLOSED' | 'OPEN' | 'HALF_OPEN' = 'CLOSED';
    
    async execute<T>(fn: () => Promise<T>): Promise<T> {
        if (this.state === 'OPEN') {
            throw new Error('Circuit breaker is OPEN');
        }
        
        try {
            const result = await fn();
            this.onSuccess();
            return result;
        } catch (error) {
            this.onFailure();
            throw error;
        }
    }
    
    private onSuccess() {
        this.failures = 0;
        this.state = 'CLOSED';
    }
    
    private onFailure() {
        this.failures++;
        if (this.failures >= 5) {
            this.state = 'OPEN';
            setTimeout(() => this.state = 'HALF_OPEN', 60000);
        }
    }
}
```

### 3. æ·»åŠ è¯·æ±‚å»é‡
é˜²æ­¢é‡å¤è¯·æ±‚ï¼š
```typescript
class RequestDeduplicator {
    private pending = new Map<string, Promise<any>>();
    
    async deduplicate<T>(key: string, fn: () => Promise<T>): Promise<T> {
        if (this.pending.has(key)) {
            return this.pending.get(key) as Promise<T>;
        }
        
        const promise = fn().finally(() => {
            this.pending.delete(key);
        });
        
        this.pending.set(key, promise);
        return promise;
    }
}
```

### 4. ä¼˜åŒ–æµ‹è¯•è¦†ç›–
å½“å‰æµ‹è¯•æ–‡ä»¶å­˜åœ¨é—®é¢˜ï¼Œå»ºè®®é‡å†™ï¼š
```typescript
// ä½¿ç”¨ mock é¿å…çœŸå®ç½‘ç»œè¯·æ±‚
jest.mock('axios');

describe('SessionManager', () => {
    beforeEach(() => {
        // é‡ç½® mock
        jest.clearAllMocks();
        
        // Mock axios.get
        (axios.get as jest.Mock).mockResolvedValue({
            headers: {
                'set-cookie': ['JSESSIONID=xxx; Path=/', 'tk=yyy; Path=/']
            }
        });
    });
    
    // æµ‹è¯•ç”¨ä¾‹...
});
```

### 5. æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹
```typescript
server.tool(
    'health-check',
    'æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€',
    {},
    async () => {
        const health = sessionManager.getHealthStatus();
        const apiHealthy = await apiClient.healthCheck();
        
        return {
            content: [{
                type: 'text',
                text: JSON.stringify({
                    status: health.isHealthy && apiHealthy ? 'healthy' : 'unhealthy',
                    sessionManager: health,
                    apiClient: { healthy: apiHealthy }
                }, null, 2)
            }]
        };
    }
);
```

### 6. å®ç°ä¼˜é›…é™çº§
å½“ä¼šè¯æ± è€—å°½æ—¶ï¼Œæä¾›é™çº§æœåŠ¡ï¼š
```typescript
async getSessionWithFallback(): Promise<Session> {
    try {
        return await this.getSession();
    } catch (error) {
        if (error instanceof SessionError && error.type === ErrorType.RATE_LIMIT) {
            console.warn('[SessionManager] Pool saturated, creating temporary session');
            // åˆ›å»ºä¸´æ—¶ä¼šè¯ï¼Œä¸åŠ å…¥æ± 
            const cookies = await this._fetchNewCookies();
            const userAgent = USER_AGENTS[Math.floor(Math.random() * USER_AGENTS.length)];
            return new Session({ cookies, userAgent });
        }
        throw error;
    }
}
```

## ğŸ“Š ä»£ç è´¨é‡æŒ‡æ ‡

### å½“å‰çŠ¶æ€
- **ä»£ç è¡Œæ•°**: ~1500 è¡Œ
- **åœˆå¤æ‚åº¦**: å¹³å‡ 5-8
- **é‡å¤ä»£ç **: <5%
- **æµ‹è¯•è¦†ç›–ç‡**: ~60%ï¼ˆéœ€æå‡ï¼‰

### æ”¹è¿›ç›®æ ‡
- **æµ‹è¯•è¦†ç›–ç‡**: 80%+
- **åœˆå¤æ‚åº¦**: <10
- **ä»£ç é‡å¤**: <3%
- **æ–‡æ¡£è¦†ç›–**: 100%

## ğŸ¯ è¡ŒåŠ¨è®¡åˆ’

### çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰
1. âœ… ä¿®å¤æ–‡ä»¶è·¯å¾„é—®é¢˜
2. âœ… ä¿®å¤ types.js å†…å®¹
3. âœ… æ·»åŠ ç¯å¢ƒå˜é‡æ”¯æŒ
4. âœ… ä¼˜åŒ–é”™è¯¯å¤„ç†
5. âœ… æ·»åŠ å¹¶å‘æ§åˆ¶

### ä¸­æœŸï¼ˆ1ä¸ªæœˆå†…ï¼‰
1. å¼•å…¥ç»“æ„åŒ–æ—¥å¿—
2. æ·»åŠ  Prometheus æŒ‡æ ‡
3. å®ç°æ–­è·¯å™¨æ¨¡å¼
4. ä¼˜åŒ–æµ‹è¯•è¦†ç›–ç‡åˆ° 80%
5. æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•

### é•¿æœŸï¼ˆ3ä¸ªæœˆå†…ï¼‰
1. å®ç°è¯·æ±‚ç¼“å­˜å±‚
2. æ·»åŠ åˆ†å¸ƒå¼è¿½è¸ªï¼ˆOpenTelemetryï¼‰
3. å®ç°è‡ªé€‚åº”æ± å¤§å°è°ƒæ•´
4. æ·»åŠ  A/B æµ‹è¯•æ¡†æ¶
5. å®ç°æ™ºèƒ½é™æµç®—æ³•

## ğŸ“ æ€»ç»“

### ä¼˜ç‚¹
1. âœ… æ¶æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†æ˜
2. âœ… ä¼šè¯æ± è®¾è®¡åˆç†
3. âœ… çŠ¶æ€æœºå®ç°æ­£ç¡®
4. âœ… è‡ªåŠ¨ç»´æŠ¤æœºåˆ¶å®Œå–„

### éœ€æ”¹è¿›
1. âŒ æµ‹è¯•è¦†ç›–ä¸è¶³
2. âŒ æ—¥å¿—ç³»ç»Ÿç®€é™‹
3. âŒ ç¼ºå°‘ç›‘æ§æŒ‡æ ‡
4. âŒ é…ç½®ç®¡ç†ä¸çµæ´»

### é£é™©è¯„ä¼°
- **ä½é£é™©**: æ ¸å¿ƒé€»è¾‘ç¨³å®š
- **ä¸­é£é™©**: å¹¶å‘åœºæ™¯ä¸‹çš„è¡¨ç°
- **é«˜é£é™©**: ç½‘ç»œå¼‚å¸¸æ—¶çš„æ¢å¤èƒ½åŠ›

**æ€»ä½“è¯„åˆ†**: 7.5/10

ç»è¿‡ä¼˜åŒ–åé¢„æœŸè¯„åˆ†: 9/10

---

**å®¡æŸ¥äºº**: Senior Algorithm Engineer  
**å®¡æŸ¥æ—¥æœŸ**: 2025-10-20  
**ä¸‹æ¬¡å®¡æŸ¥**: 2025-11-20