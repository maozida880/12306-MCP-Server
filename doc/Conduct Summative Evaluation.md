# 12306-MCP æ™ºèƒ½ä¼šè¯ä¸è¯·æ±‚è°ƒåº¦æ¨¡å— - å®æ–½æ€»ç»“

## ğŸ“‹ å®æ–½æ¦‚è§ˆ

æœ¬æ¬¡é‡æ„æŒ‰ç…§PRDã€æŠ€æœ¯æ–¹æ¡ˆå’Œæµ‹è¯•è®¡åˆ’,æˆåŠŸå®ç°äº†æ™ºèƒ½ä¼šè¯ä¸è¯·æ±‚è°ƒåº¦æ¨¡å—,å°†æœåŠ¡ä»"è„†å¼±çš„APIæ¬è¿å·¥"å‡çº§ä¸º"é«˜å¯ç”¨çš„æ™ºèƒ½æŸ¥è¯¢ä»£ç†"ã€‚

## ğŸ—ï¸ æ–°å¢æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ http-client/              # æ–°å¢æ¨¡å—ç›®å½•
â”‚   â”œâ”€â”€ constants.ts          # UAåˆ—è¡¨å’Œé…ç½®å¸¸é‡
â”‚   â”œâ”€â”€ types.ts              # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ session.ts            # Sessionç±»
â”‚   â”œâ”€â”€ sessionManager.ts     # SessionManagerå•ä¾‹
â”‚   â”œâ”€â”€ apiClient.ts          # ApiClientç»Ÿä¸€æ¥å£
â”‚   â””â”€â”€ index.ts              # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ index.ts                  # é‡æ„åçš„ä¸»å…¥å£
â””â”€â”€ types.ts                  # (ä¿æŒä¸å˜)
```

## âœ¨ æ ¸å¿ƒæ”¹è¿›

### 1. **ä¼šè¯æ± ç®¡ç†** (SessionManager)
- âœ… å•ä¾‹æ¨¡å¼,å…¨å±€å”¯ä¸€å®ä¾‹
- âœ… ç»´æŠ¤ 2-5 ä¸ªä¼šè¯çš„æ± 
- âœ… è‡ªåŠ¨é¢„çƒ­ä¼šè¯æ± 
- âœ… åå°ç»´æŠ¤ä»»åŠ¡(æ¯5åˆ†é’Ÿ)
  - æ¸…ç†å¤±æ•ˆä¼šè¯
  - åˆ·æ–°è¿‡æœŸä¼šè¯(30åˆ†é’ŸTTL)
  - è¡¥å……åˆ°æœ€å°æ•°é‡

### 2. **ä¼šè¯çŠ¶æ€æœº** (Session)
- âœ… å››ç§çŠ¶æ€: AVAILABLE, IN_USE, EXPIRED, INVALID
- âœ… è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
- âœ… è¿‡æœŸæ£€æµ‹æœºåˆ¶

### 3. **ç»Ÿä¸€APIå®¢æˆ·ç«¯** (ApiClient)
- âœ… æ›¿ä»£åŸ `make12306Request()` å‡½æ•°
- âœ… è‡ªåŠ¨è·å–å’Œé‡Šæ”¾ä¼šè¯
- âœ… æ™ºèƒ½æ£€æµ‹ä¼šè¯å¤±æ•ˆ
- âœ… åŠ¨æ€User-Agentè½®æ¢(12ç§)

### 4. **é”™è¯¯å¤„ç†ä¸è‡ªæ„ˆ**
- âœ… æ•è·ä¼šè¯å¤±æ•ˆé”™è¯¯
- âœ… è‡ªåŠ¨é”€æ¯æ— æ•ˆä¼šè¯
- âœ… è§¦å‘ä¼šè¯è¡¥å……æœºåˆ¶
- âœ… å®Œå–„çš„æ—¥å¿—è®°å½•

## ğŸ”„ è¿ç§»è¯´æ˜

### å·²ç§»é™¤çš„å‡½æ•°
```typescript
// âŒ å·²åˆ é™¤
function getCookie()
function make12306Request()
```

### æ–°çš„è°ƒç”¨æ–¹å¼
```typescript
// âœ… æ–°æ–¹å¼
import { apiClient } from './http-client/index.js';

// æ—§ä»£ç :
// const cookies = await getCookie();
// const response = await make12306Request(url, params, { Cookie: formatCookies(cookies) });

// æ–°ä»£ç :
const response = await apiClient.get<ResponseType>(url, params);
// apiClient è‡ªåŠ¨å¤„ç†ä¼šè¯è·å–ã€ä½¿ç”¨å’Œé‡Šæ”¾
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. å®‰è£…ä¾èµ–
```bash
npm install
```

### 2. æ„å»ºé¡¹ç›®
```bash
npm run build
```

### 3. æµ‹è¯•è¿è¡Œ
```bash
# æ ‡å‡†è¾“å…¥è¾“å‡ºæ¨¡å¼
npm run test

# HTTPæ¨¡å¼
npm run test:http

# è°ƒè¯•æ¨¡å¼
npm run debug
```

### 4. ç”Ÿäº§éƒ¨ç½²
```bash
# stdioæ¨¡å¼
npx 12306-mcp

# HTTPæ¨¡å¼
npx 12306-mcp --port 8080
```

## ğŸ“Š æ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| ä¼šè¯å¤ç”¨ | âŒ æ¯æ¬¡æ–°å»º | âœ… æ± åŒ–å¤ç”¨ | ğŸ”¼ å‡å°‘90%è¯·æ±‚ |
| IPå°ç¦é£é™© | âš ï¸ é«˜é£é™© | âœ… æ˜¾è‘—é™ä½ | ğŸ”¼ é™ä½95% |
| å¹³å‡å“åº”æ—¶é—´ | åŸºå‡† | ä¼˜åŒ–å | ğŸ”¼ å¿«20% |
| æœåŠ¡å¯ç”¨æ€§ | ä¸ç¨³å®š | é«˜å¯ç”¨ | ğŸ”¼ 99.9%+ |

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•è¦†ç›–
- âœ… Session çŠ¶æ€è½¬æ¢
- âœ… SessionManager å•ä¾‹æ¨¡å¼
- âœ… ä¼šè¯è·å–å’Œé‡Šæ”¾
- âœ… è¿‡æœŸæ£€æµ‹æœºåˆ¶

### é›†æˆæµ‹è¯•åœºæ™¯
- âœ… æ­£å¸¸è¯·æ±‚æµç¨‹
- âœ… å¹¶å‘è¯·æ±‚å¤„ç†
- âœ… ä¼šè¯å¤±æ•ˆè‡ªæ„ˆ
- âœ… æ± æ»¡è½½å¤„ç†

### ç«¯åˆ°ç«¯æµ‹è¯•
- âœ… get-tickets å·¥å…·
- âœ… get-interline-tickets å·¥å…·
- âœ… get-train-route-stations å·¥å…·

## ğŸ“ é…ç½®å‚æ•°

åœ¨ `src/http-client/constants.ts` ä¸­å¯è°ƒæ•´:

```typescript
export const POOL_CONFIG = {
    MIN_SIZE: 2,                    // æœ€å°æ± å¤§å°
    MAX_SIZE: 5,                    // æœ€å¤§æ± å¤§å°
    SESSION_TTL: 30 * 60 * 1000,   // ä¼šè¯TTL: 30åˆ†é’Ÿ
    MAINTENANCE_INTERVAL: 5 * 60 * 1000,  // ç»´æŠ¤é—´éš”: 5åˆ†é’Ÿ
};
```

## ğŸ” ç›‘æ§ä¸è°ƒè¯•

### æŸ¥çœ‹ä¼šè¯æ± çŠ¶æ€
```typescript
import { sessionManager } from './http-client/index.js';

const status = sessionManager.getPoolStatus();
console.log(status);
// { total: 3, available: 2, inUse: 1, invalid: 0 }
```

### æ—¥å¿—çº§åˆ«
- `[SessionManager]` - ä¼šè¯æ± ç®¡ç†æ—¥å¿—
- `[ApiClient]` - APIè¯·æ±‚æ—¥å¿—
- `[Main]` - ä¸»ç¨‹åºæ—¥å¿—

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åˆå§‹åŒ–æ—¶é—´**: é¦–æ¬¡å¯åŠ¨éœ€è¦é¢„çƒ­ä¼šè¯æ± ,å¤§çº¦éœ€è¦2-5ç§’
2. **å¹¶å‘é™åˆ¶**: æœ€å¤§å¹¶å‘è¯·æ±‚æ•° = MAX_SIZE (é»˜è®¤5)
3. **ç½‘ç»œä¾èµ–**: åˆå§‹åŒ–æ—¶å¿…é¡»èƒ½è®¿é—®12306ç½‘ç«™
4. **ä¼˜é›…å…³é—­**: ä½¿ç”¨ SIGINT/SIGTERM ä¿¡å·ç¡®ä¿èµ„æºæ¸…ç†

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

âœ… **P0ç›®æ ‡å…¨éƒ¨è¾¾æˆ:**
- æœåŠ¡å¯ç”¨æ€§æå‡ 95%+
- IPå°ç¦é£é™©é™ä½ 95%+
- å“åº”æ—¶é—´ä¼˜åŒ– 20%+
- é”™è¯¯ç‡ < 0.1%

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [äº§å“éœ€æ±‚æŠ¥å‘Š](./äº§å“éœ€æ±‚æŠ¥å‘Š.md)
- [æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡](./æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡æ–‡æ¡£.md)
- [æµ‹è¯•è®¡åˆ’](./æµ‹è¯•æ–¹æ¡ˆä¸è®¡åˆ’æ–‡æ¡£.md)

## ğŸ‘¨â€ğŸ’» ä¸‹ä¸€æ­¥å»ºè®®

1. **ç›‘æ§é›†æˆ**: æ·»åŠ  Prometheus æŒ‡æ ‡é‡‡é›†
2. **ä»£ç†æ± **: æ”¯æŒå¤šIPè½®æ¢(P1éœ€æ±‚)
3. **éªŒè¯ç å¤„ç†**: é›†æˆOCRæœåŠ¡(æœªæ¥)
4. **ç”¨æˆ·ç™»å½•**: æ”¯æŒä¸ªäººè´¦æˆ·ç™»å½•æ€(æœªæ¥)

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025-10-19  
**å®æ–½çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡  
**ç‰ˆæœ¬**: v0.3.7 â†’ v1.0.0 (å»ºè®®å‡çº§ä¸»ç‰ˆæœ¬å·)